function doPost(e) {
  try {
    // ✅ POSTデータの存在チェック
    if (!e || !e.postData) {
      Logger.log("⚠️ エラー: postDataが存在しません。");
      return ContentService.createTextOutput("Error: No postData received.").setMimeType(ContentService.MimeType.TEXT);
    }

    // ✅ POSTデータのパース
    var jsonData = JSON.parse(e.postData.contents);
    Logger.log("✅ 受信データ: " + JSON.stringify(jsonData));

    // ✅ ABILI IDとLINE IDの取得
    var lineUserId = jsonData.lineUserId;
    var abiliId = jsonData.abiliId;

    if (!lineUserId || !abiliId) {
      Logger.log("⚠️ エラー: 必要なデータが不足しています。");
      return ContentService.createTextOutput("Error: Missing required data.");
    }

    // ✅ チャネルアクセストークン (Messaging API)
    var accessToken = "Bearer McLJ217ucwU7496mDrSv8xJiV6CUknDVt7rZUJfeFT4fQFldyoX1bLgLLvst2GriWMQcctNY3lrkM0XVp5gKvjInD5uJbCDQiEjIlKCOMuvLidZrpXnwN9TtR+VcMjXPE6r0DGKb3Z8Mx4pchOaspAdB04t89/1O/w1cDnyilFU=";

    // ✅ LINEへ送信するメッセージの定義
    var message = {
      "to": lineUserId,  // 友達登録時のLINEユーザーIDを直接使用
      "messages": [{
        "type": "text",
        "text": `✅ ABILI ID: ${abiliId}\n✅ LINE ID: ${lineUserId}\nデータ受信完了しました！`
      }]
    };

    // ✅ Messaging APIへデータ送信
    var response = UrlFetchApp.fetch("https://api.line.me/v2/bot/message/push", {
      "method": "post",
      "headers": {
        "Content-Type": "application/json",
        "Authorization": accessToken
      },
      "payload": JSON.stringify(message)
    });

    Logger.log("✅ LINE APIレスポンス: " + response.getContentText());
    return ContentService.createTextOutput("Webhook received successfully.").setMimeType(ContentService.MimeType.TEXT);

  } catch (error) {
    Logger.log("❌ エラー発生: " + error);
    return ContentService.createTextOutput("Error: " + error).setMimeType(ContentService.MimeType.TEXT);
  }
}
